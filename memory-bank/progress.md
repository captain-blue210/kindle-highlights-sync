# 進捗状況 (日本語更新: 2025-03-30)

## 1. 機能していること

*   **Amazon認証:**
    *   指定されたAmazonリージョンのログインページを独立した `BrowserWindow` で表示できる。
    *   ログイン成功を検出し、ウィンドウを非表示にして参照を保持できる (`AmazonLoginModal`)。
    *   `KindleApiService` がログイン状態 (`loggedIn`) とウィンドウ参照 (`loginWindow`) を管理できる。
*   **ノートブックページへのアクセス:**
    *   ログイン時に保持した `BrowserWindow` を再利用して、Kindle Notebook ページ (`read.amazon.com/notebook` など) にアクセスできる (`loadRemoteDom`)。
    *   User-Agent を設定してアクセスできる。
*   **コンテンツの動的読み込み待機:**
    *   `loadRemoteDom` 内でタイムアウトを設定し、ページの初期読み込み後に待機することで、JavaScriptによる動的コンテンツ（書籍リストなど）の読み込みを待機できる（現在は5秒）。
    *   コンテンツ（`.kp-notebook-library-each-book`）が存在するかどうかを確認できる。
*   **書籍情報の抽出:**
    *   読み込んだノートブックページのHTMLから、書籍の基本情報（ASIN/ID, タイトル, 著者, 画像URL, 最終更新日）を抽出できる (`KindleApiService` 内のパーサー）。
    *   日付文字列を `moment` を使ってパースできる（日本語形式対応済み）。
*   **ビルド:** `npm run build` および `npm run deploy:test` が警告なしで成功する。

## 2. 残っているタスク

*   **ハイライト情報の抽出:**
    *   ノートブックページのHTMLからハイライト情報（テキスト、色、位置、ページ、メモ）を抽出するロジック (`KindleApiService` 内の `$(HIGHLIGHT_CONTAINER_SELECTOR).each(...)`) が現在のHTML構造で正しく機能するか検証し、必要であれば修正する。
    *   ハイライトの色をマッピングするロジック (`mapTextToColor` のようなもの) を実装する。
*   **リージョン対応の完全化:**
    *   `parseToDateString` や書籍URL生成ロジックが、設定されたAmazonリージョンに基づいて正しく動作するように修正する。
    *   `REGION_URLS` に含まれていない他のリージョン（例: `fr`）の日付形式などに対応する。
*   **ノート生成:**
    *   抽出した書籍情報とハイライト情報を使って、`TemplateRenderer` が正しくMarkdownノートを生成できるか確認・調整する。
    *   テンプレート内で新しい書籍フィールド (`asin`, `url`, `imageUrl`, `lastAnnotatedDate`) を利用できるようにする。
*   **リファクタリング:**
    *   `KindleApiService` 内のHTMLパースロジックを `HighlightParser` サービスに分離する。
*   **ログアウト処理の改善:**
    *   保持している `BrowserWindow` のセッション（Cookieなど）を確実にクリアするログアウト機能を実装する。
*   **エラーハンドリングの強化:**
    *   セッション切れ、ネットワークエラー、予期せぬHTML構造など、より多くのエッジケースに対応する。
    *   ユーザーへのフィードバックをより分かりやすくする。
*   **UI/UX:**
    *   設定画面でリージョン選択などを分かりやすく表示する。
    *   同期中の進捗表示（任意）。
    *   リボンアイコンの追加（任意）。
*   **テスト:**
    *   様々なアカウント、書籍、ハイライトデータでテストする。
    *   異なるAmazonリージョンでテストする。

## 3. 現在のステータス

*   コアとなるHTML取得と書籍情報の基本的なパースは機能するようになった。
*   `electron.remote` を利用するアーキテクチャに移行したが、そのリスクは認識している。
*   ハイライト情報のパースと、より詳細な機能（リージョン対応、ノート生成の調整など）の実装が必要。

## 4. 既知の問題点

*   `electron.remote` の利用に伴う潜在的なリスク（非推奨、将来の互換性）。
*   HTMLスクレイピングに依存するため、Amazon側のUI変更に弱い。
*   動的コンテンツの読み込み待機時間が固定（5秒）であり、環境によっては不安定になる可能性がある。
*   ハイライト抽出ロジックが未検証・未修正。
